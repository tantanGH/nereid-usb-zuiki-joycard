===============================================================================
===============================================================================


　　　　　　　USB JoyPad & Mouse Driver USBJOY ver.1.3e

　　　　　　　　　　　　　　　　Copyright (C)2006-2009 by ぷらすちっく/あく蔵


===============================================================================
===============================================================================

-------------------------------------------------------------------------------
＃１・はじめに
-------------------------------------------------------------------------------

　　X-PowerStation製NereidのUSB機能を利用した常駐型のジョイパッドドライバです。

　　USBの勉強も兼ねて作成してみました。

　　IOCS _JOYGETを乗っ取る形で常駐する為、直接ジョイスティックポートを参照
　しているソフトでは動作しませんのでご注意ください。

　　そういったソフトは勉強も兼ねて適当に自分で作り替えてね☆

　　また、ver.1.2以降、あく蔵氏によりUSBマウスへの対応が実現されました。

　　是非、お手持ちのUSBマウスを試してみてください。

　　マウスを使用する際は、後述する「＃２・現在の仕様」「＃３・使用方法」を
　御一読覧ください。

-------------------------------------------------------------------------------
＃２・現在の仕様
-------------------------------------------------------------------------------

　　現在の仕様では、使用できるジョイパッドおよびマウスはNereidのUSBコネクタに
　直接接続した１つのみになります。

・マウス

　　Windowsで使用する際、ドライバが不要な一般的なUSBマウスでしたら、基本的に
　使用可能です。

　　また、常駐中はX68000側のマウスは「使用不可能」となります。

　　マウスの左ボタンと中ボタンを同時に押すことにより、いつでも分解能を２分の１
　に変更する事ができます。

　　もう一度押すと元の分解能に戻ります。

　　左ボタンを押しながら中ボタンを押せば確実に切り替え可能だと思います。

・ジョイパッド

　　接続されたジョイパッドはジョイスティック１と２に代わり動作するようになります。

　　現在、標準で以下のジョイパッドまたは変換アダプタに対応しています。

　　・ジョイスティック１のみ対応(ジョイスティック２はそのまま)

	SANWA SUPPLY JY-P35U
	SANWA SUPPLY JY-P1R(CLASSIC USB GAMEPAD)
	SANWA SUPPLY JY-PSUAD1 or UCVPS1(PSパッド変換アダプタ)
	ELECOM JC-PS101U(PSパッド変換アダプタ)
	ELECOM JC-U1608T/RD/BK/WH
	ELECOM JC-U2208T/RD/BK/WH
	ELECOM JC-U711/BK/BS/SV
	SK-NET SK-SJPD2(SMART JOYPAD 2/PSパッド変換アダプタ)
	SK-NET SK-SJPD3(SMART JOYPAD 3/PSパッド変換アダプタ)
	SK-NET SK-SJP3Q(SMART JOYPAD 3Q/GCパッド変換アダプタ)
	E.M.S TRIO LINKER(PS/DC/GCパッド変換アダプタ)
	E.M.S TRIO LINKER PLUS(PS/DC/GCパッド変換アダプタ)
	HORI HPC-02(ワイヤレスアナ振ＰＣ ブラック)
	SEGA CS2-0002/3/4/5/6(復刻版 セガサターンコントロールパッド)
	GAMETECH PRO-SHOCK ARCADE
	ASCII ASC-1610p (ASCII PAD USB mini)
	Microsoft XBOX360 Controller(有線)
	HORI HX3-07 (Fighting Stick EX2 : Xbox 360)


　　・ジョイスティック１と２の両方に対応

	SANWA SUPPLY JY-PSUAD2 or UCVPS2(PSパッド変換アダプタ)
	SK-NET SK-SJP3P(SMART JOYPAD 3 Plus/PSパッド変換アダプタ)

　　上記のパッドをお持ちで無い場合は、エンドポイントからのパケットの内容を調べ
　添付の定義ファイル「usbjoy.def」に定義を追記することで、大抵のものは使用する
　事ができるようになるはずです。

　　パケット内容の調べ方は後述します。

　　なお、定義ファイルの最大サイズは32KBとなっております。

-------------------------------------------------------------------------------
＃３・使用方法
-------------------------------------------------------------------------------

　　コマンドラインから

　　　usbjoy [-option]････

　　と実行することで常駐します。

　　もう一度実行すると常駐解除します。

　　添付の定義ファイル「usbjoy.def」は「usbjoy.x」と同じフォルダに置いておけば
　自動に読み込みますので、新規登録する際以外は意識する必要はありません。

　　ジョイパッドが繋がっているかマウスが繋がっているかは「自動認識」致します。

　　また、マウスの場合はパケットフォーマットが統一されているため、定義ファイル
　への登録等は一切必要ありません。

-------------------------------------------------------------------------------
＃４・オプションの説明
-------------------------------------------------------------------------------

　　現在は以下の５つのみです。

　　-a1 : シンクロ連射(1frame毎にボタンのON/OFFを切り替え)
　　-a2 : シンクロ連射(2frame毎にボタンのON/OFFを切り替え)
　　-c  : エンドポイントからのパケット内容チェックモード
　　-h  : ヘルプ表示
　　-x  : Xbox 360 系のコントローラを使用する場合に指定

　　パッチを当ててIOCS _JOYGETを使えるように変更したスペースハリアーや
　ファンタジーゾーンでは-a1が、ドラゴンスピリットでは-a2がお勧めです。

　　なお、現在シンクロ連射が有効になるボタンは

	LBTN2 : 左ボタン２(左ボタン１と同じ機能を別のボタンに割り当てる際に定義)
	RBTN2 : 右ボタン２(右ボタン１と同じ機能を別のボタンに割り当てる際に定義)

　　の２つに割り当てたボタンのみです。

-------------------------------------------------------------------------------
＃５・エンドポイントから入力されるパケット内容の調べ方
-------------------------------------------------------------------------------

　　コマンドラインから

　　　usbjoy -c

　　と実行することで、常駐せずにエンドポイントからのパケット内容をチェックする
　モードになります。

　　このモードのみで添付の定義ファイル「usbjoy.def」内のVID〜INTRに指定する値
　全てを調べることができ、未対応のジョイパッドも使用できるようになります。

　　定義ファイル内にも簡単な説明があるのでご覧ください。

　　ちょっと勘のいい方でしたら、その説明だけですぐに登録できると思います。

　　マウス接続時もこのモードは使用可能ですが、定義ファイルの登録が不要なので
　特に意味はありません。

　　また、パケット内容チェックモードで以前取得できたマウスのホイールのデータが
　取得できなくなったとしても、それは「Boot Protocol」の仕様です。

　　逆に、取得できる物はマウスのファームウェアの手抜きの可能性が大です。

-------------------------------------------------------------------------------
＃６・開発および動作確認環境（敬称略）
-------------------------------------------------------------------------------

　開発環境

　　X68000 Compact XVI
　　X68030 Compact
　　X68030 + 060turbo
　　X68000XVI + 060Excel


　開発ソフトウェア

　　HAS060.X version 3.09+87			Y.Nakamura/M.Kamada
　　HLK evolution version 3.01+14		SALT/立花えり子
　　MY.X Ver 1.16				JOJO
　　usbmon - Nereid USB Monitor version 0.52	立花えり子


　動作確認環境

　　X68000 XVI(10MHz/18MHz)
　　X68000 Compact XVI(10MHz/24MHz)
　　X68030 Compact(25MHz)
　　X68030 + 060turbo(50MHz)

-------------------------------------------------------------------------------
＃７・参考書籍および参考資料（敬称略）
-------------------------------------------------------------------------------

　参考書籍

　　68000 プログラマーズ・ハンドブック		宍倉　幸則	技術評論社
　　Inside X68000				Masahiko Kuwano	SOFT BANK
　　Interface 2005年12月号			CQ出版社


　参考資料

　　Nereid for X680x0 取扱説明書		X-PowerStation
　　ぷにぐらま〜ずまにゅある 第七版第二刷	立花えり子
　　SL811HS.pdf					Cypress(旧ScanLogic)
　　SL811HSErrata.pdf				　〃


　参考ソフト(常駐部、マウス割り込み部)

　　IBM互換機用シリアルマウスドライバ on x68k	たぼ
　　　　　　　　　　　　　　　　　Version 0.2.

-------------------------------------------------------------------------------
＃８・謝辞
-------------------------------------------------------------------------------

　　興味深く面白いボードを作ってくださった 永井氏、

　　usbmonを作成された 立花えり子氏、

　　早速、不具合報告をしてくださった ぴぴぴ☆氏、

　　USBマウスへの対応を行っていただきました あく蔵氏、

　　ジョイパッドの動作確認情報をいただきました 菅谷氏、GACHA氏、立花氏、

　　常駐部、およびマウス対応の際、プログラムを参考させていただきました たぼ氏、

　　に深く御礼申し上げます。

-------------------------------------------------------------------------------
＃９・今後の予定
-------------------------------------------------------------------------------

　　シンクロ連射の設定を細かくできるようにする。

　　SFXVI対応。(別プログラムにする可能性あり)

　　サイバースティック互換モード対応。

-------------------------------------------------------------------------------
＃１０・現在当方で確認している不具合
-------------------------------------------------------------------------------

　　X68030+060turboにおいて、ノーパッチの「SX-Window ver3.1」ではエラーが出て
　使用不可能でした。(X68030やX68000 XVIではエラーは出ませんでした)

　　他にも動作しないソフトなどありましたら、なるべく詳細な動作環境とともに
　御報告頂ければ幸いです。

-------------------------------------------------------------------------------
＃１１・あとがき
-------------------------------------------------------------------------------

　　本ソフトはフリーソフトウェアです。

　　本ソフトを使用することによって生じたいかなる損害にも、作者は一切の責任を
　負いません。

　　著作権は放棄しません(法律上できません)が、内容を参照して自作プログラム等に
　応用していただく事への制限は一切ありません。

　　バグなど見つけましたら、ご連絡頂ければ幸いです。

　　また、当プログラムの改変版を配布等する際のバージョン表記は次の様にお願い
　致します。

　　例えば、このバージョンを元にした場合は「ver.1.2」の部分には変更は加えず、
　「ver.1.2+01」のように＋表記でお願い致します。

　　また、ソースも添付し改変者および改変部分がわかるようお願い致します。

-------------------------------------------------------------------------------
＃１２・お願い
-------------------------------------------------------------------------------

　　どなたか「MY.X Ver 1.16」が060turbo.sysの-xmオプション有りでも暴走しない
　ようにパッチを当ててくださいませ。

-------------------------------------------------------------------------------
＃１３・連絡先
-------------------------------------------------------------------------------

　　mixi(ミクシィ):

	http://mixi.jp/show_friend.pl?id=761031

　　HomePage:

	http://www.dcn.ne.jp/~plastic

　　E-Mail: (Hotmail等、フリーのメールアドレスからのメールは受け取れません)

	plastic@po.dcn.ne.jp

-------------------------------------------------------------------------------
＃１４・変更履歴
-------------------------------------------------------------------------------

　2006/08/03		ver.1.0

	初登場

　2006/08/04		ver.1.1

	パケット内容チェックモードを利用する際、VIDとPIDを定義ファイルへ
	仮登録する必要があったものを修正。

	定義ファイル内のメモを別ファイルに分離。

　2006/08/05		ver.1.1a

	USBの割り込み中にX68000側の割り込みの一部にマスクをかけていたものを
	やめました。

	高速マシンでは特に問題は出ていなかったのですが、これにより手元の
	X68000XVI-18MHzでの常駐時の安定度はあがりました。

	逆に高速マシンで不安定になるようでしたら、ver.1.1を使用してください。

	定義ファイルも添付しておりますが、ver.1.1のものがそのまま使用可能です。

	テスト時にさえ全く使っていない不要なルーチンを削除し、ファイルサイズを
	削減しました。

	ソースの添付を開始しました。

　2006/08/12		ver.1.2

	USBマウスに正式対応致しました。

	それに伴い、従来のソースの小規模な仕様変更も行っております。

	新規ジョイパッド２つに正式対応致した事により、定義ファイルが更新されて
	おります。

	もう、疲れました。

　2006/08/14		ver.1.2a

	USBチップSL811HSTのRev.1.5で常駐が不安定になる対策をしました。

	Rev.1.5を持っているわけではないので、動作保証はありません。

	定義ファイルも添付しておりますが、ver.1.2のものがそのまま使用可能です。

	修正後のソースのサイズが偶然にも68000バイトになりました記念カキコ。

　2006/08/14		ver.1.2c

	マウス対応時にジョイパッドのチェックモードがエンバグしていたのを修正。

	定義ファイルも添付しておりますが、ver.1.2のものがそのまま使用可能です。

　2006/08/17		ver.1.2e

	HORI HPC-02(ワイヤレスアナ振ＰＣ ブラック)に対応しました。

	SEGA CS2-0002/3/4/5/6(復刻版 セガサターンコントロールパッド)に対応しました。

	これは今までパケットの取得データが異常で残念ながら未対応のままでしたが、
	初期化ルーチンをusbtest.xの最新版と置き換える事で対応しました。

	新規ジョイパッド２つに正式対応致した事により、定義ファイルが更新されて
	おります。

	インタラプト転送の際、ショートパケットをエラー扱いにしているものを一時的に
	解除しました。(エラー扱いが正常。その代わり本当のエラーとの区別はつかない)

	この解除により、今まで一見パケットが取得できていないように見えた機器も
	パケットが見えるようになり一部のマウスが動作可能になります。

	これはマウスの定義ファイル対応が完了し次第、エラー扱いに戻します。

　2006/08/21		ver.1.2g

	認識の遅い一部のマウスがデバイス接続されていない状態になるのを修正しました。

	Microsoft「IntelliMouse Explorer」等、「Report Protocol」で標準的でない
	パケットを返してくるマウスに対応する為、初期化時に「Boot Protocol」を
	選択するようにしました。

	この変更により、基本的に全てのUSBマウスに対応できている筈です。

	パケット内容チェックモードで以前取得できたマウスのホイールのデータが
	取得できなくなったとしても、それは「Boot Protocolの仕様」です。

	逆に、取得できる物はマウスのファームウェアの手抜きの可能性が大です。

	NAK時のリトライ回数を減らしました。(512 -> 64)

	定義ファイルも添付しておりますが、ver.1.2のものがそのまま使用可能です。

　2006/09/07		ver.1.3

	分解能が高いマウス用にマウスの左ボタンと中ボタンを同時に押すことにより
	通常モードと２分の１モードを切り替えることができるようにしました。

	これにより、通常モードで800カウントのマウスでしたら、２分の１モードで
	400カウントのマウスとして扱えます。

	左ボタンを押しながら中ボタンを押せば確実に切り替え可能だと思います。

	パケット内容チェックモードで中ボタンが取得可能なマウスでしたら、モードの
	変更は常時可能です。

	リポートＩＤを利用して２つのジョイパッドの接続を可能にしている変換器に
	対応しました。

	これにより「SMART JOYPAD 3 Plus」や「JY-PSUAD2」が使用可能になりました。

	上記に伴い、定義ファイルにリポートＩＤの位置指定が加わりフォーマットが
	変更になりましたので、ver.1.2までのものは使用不可能です。

　2006/10/28		ver.1.3a

	デジタルジョイパッドモードにおいて、十字キーの代わりにアナログスティック
	でも４方向操作ができるように、定義ファイルのバイト指定値を「＝」ではなく
	「以上」と「以下」で判定するように変更しました。(互換性は維持しています)

	RKEY、DKEY、LBTN1、RBTN1、LBTN2、RBTN2 に指定されたバイト値は「以上」で、
	LKEY、UKEY に指定されたバイト値は「以下」で認識します。

	例えば、LKEYに「8240」と指定すれば、EndPointから読み込んだパケットの
	2バイト目が64以下(0〜64)ならば押されていると判断します。

	ELECOM JC-U711/BK/BS/SV に対応しました。

	GAMETECH PRO-SHOCK ARCADE に対応しました。

	ASCII ASC-1610p (ASCII PAD USB mini) に対応しました。

	対応機種は増えていますが、定義ファイルはver.1.3のものがそのまま使用可能です。

　2008/10/24		ver.1.3c

	Microsoft Xbox 360 Controller (有線)に専用ルーチンで対応しました。

	Microsoft Xbox 360 Wireless Controllerは、USBケーブルで有線接続しても、
	コントローラの信号自体はワイヤレスでやり取りしているので対応不可能です。

	対応機種は増えていますが、定義ファイルはver.1.3のものがそのまま使用可能です。

　2009/03/10		ver.1.3e

	コマンドラインオプションで -x を指定することにより Xbox 360 系のコントローラを
	認識するようになりました。(有線コントローラのみ対応)

	※前回対応した純正コントローラを使用する場合も -x オプションが必要になります。

	Xbox360という単体プラットフォーム向けに出ている製品郡だけあり、取得パケットの
	互換性はあるようですが、ボタン配置について製品によって違うものもあるので、
	定義ファイルは今まで通り製品毎に必要になります。

	HORI HX3-07 (Fighting Stick EX2 : Xbox 360) に対応しました。

	対応機種は増えていますが、定義ファイルはver.1.3のものがそのまま使用可能です。
